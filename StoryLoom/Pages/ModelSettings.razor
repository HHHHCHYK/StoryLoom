@page "/settings"
@inject SettingsService Settings
@inject LlmService Llm
@inject LogService Logger

<div class="settings-page">
    <h2>⚙️ 模型设置 (Model Settings)</h2>

    <div class="form-group">
        <label>模型名称 (Model Name)</label>
        <input @bind="Settings.ModelName" placeholder="e.g. gemini-pro" />
    </div>

    <div class="form-group">
        <label>API Endpoint URL</label>
        <input @bind="Settings.ApiUrl" placeholder="https://..." />
    </div>

    <div class="form-group">
        <label>API Key</label>
        <input type="password" @bind="Settings.ApiKey" placeholder="Your API Key" />
    </div>

    <div class="action-bar">
        <button class="btn-primary" @onclick="TestConnection" disabled="@IsTesting">
            @(IsTesting ? "Testing..." : "Test Connection")
        </button>
    </div>

    @if (!string.IsNullOrEmpty(TestResult))
    {
        <div class="test-result @(TestSuccess ? "success" : "error")">
            @TestResult
        </div>
    }

    <hr />

    <div class="developer-mode">
        <div class="dev-header" @onclick="ToggleDevMode">
             <span class="arrow">@(ShowDevMode ? "▼" : "▶")</span> 开发者模式 (Developer Mode)
        </div>

        @if (ShowDevMode)
        {
            <div class="dev-content">
                <div class="form-group">
                    <label>模型温度 (Temperature): @Settings.Temperature</label>
                    <input type="range" min="0" max="1" step="0.1" @bind="Settings.Temperature" />
                </div>

                <div class="form-group">
                    <label>上下文窗口 (Context Window): @Settings.MaxContextWindow</label>
                     <input type="number" @bind="Settings.MaxContextWindow" />
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool IsTesting = false;
    private string TestResult = "";
    private bool TestSuccess = false;
    private bool ShowDevMode = false;

    /// <summary>
    /// 测试与 LLM API 的连接，并根据结果更新 UI。
    /// </summary>
    private async Task TestConnection()
    {
        Logger.Log("User initiated connection test.");
        IsTesting = true;
        TestResult = "";
        try
        {
            var response = await Llm.TestConnectionAsync();
            TestSuccess = true;
            TestResult = "✅ " + response;
            Logger.Log("Connection test UI reported success.");
        }
        catch (Exception ex)
        {
            TestSuccess = false;
            TestResult = "❌ Error: " + ex.Message;
            Logger.LogError(ex, "ModelSettings.TestConnection");
        }
        finally
        {
            IsTesting = false;
        }
    }

    private void ToggleDevMode() 
    {
        ShowDevMode = !ShowDevMode;
        Logger.Log($"Developer mode toggled: {ShowDevMode}");
    }
}

<style>
    .settings-page {
        max-width: 600px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    label {
        color: #9cdcfe;
        margin-bottom: 5px;
        font-size: 14px;
    }

    input[type="text"], input[type="password"], input[type="number"] {
        background-color: #3c3c3c;
        color: #d4d4d4;
        border: 1px solid #555;
        padding: 8px;
        border-radius: 4px;
    }

    .btn-primary {
         background-color: #0e639c;
         color: white;
         border: none;
         padding: 10px 20px;
         border-radius: 4px;
         cursor: pointer;
    }

    .btn-primary:disabled {
        background-color: #555;
        cursor: not-allowed;
    }

    .test-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        background-color: #2d2d30;
        white-space: pre-wrap;
    }

    .test-result.success { border-left: 4px solid #4CAF50; }
    .test-result.error { border-left: 4px solid #f44336; }

    .developer-mode {
        margin-top: 20px;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        overflow: hidden;
    }

    .dev-header {
        background-color: #252526;
        padding: 10px;
        cursor: pointer;
        user-select: none;
    }

    .dev-content {
        padding: 15px;
        background-color: #1e1e1e;
    }
</style>
