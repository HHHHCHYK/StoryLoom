@page "/world-building"
@inject SettingsService Settings
@inject ConversationService ConversationService
@inject LlmService Llm
@inject NavigationManager Nav
@inject LogService Logger

<div class="world-building">
    <h2>ğŸ—ºï¸ ä¸–ç•Œæ„å»º (World Building)</h2>
    
    @if (!Settings.IsModelConfigured)
    {
        <div class="alert-warning">
            âš ï¸ å°šæœªé…ç½®æ¨¡å‹ä¿¡æ¯ã€‚è¯·å‰å¾€ <a href="settings">è®¾ç½®é¡µé¢</a> é…ç½® API Keyã€‚
        </div>
    }

    <div class="split-container">
        <!-- Background Section -->
        <div class="section-box">
            <h3>èƒŒæ™¯è®¾å®š (Background)</h3>
            <textarea @bind="Settings.Background" @onfocusout="SaveWorldSettings" disabled="@IsBackgroundLocked" rows="10" placeholder="æè¿°ä½ çš„æ•…äº‹ä¸–ç•Œè§‚..."></textarea>
            <div class="controls">
                <button class="icon-btn" @onclick="() => IsBackgroundLocked = !IsBackgroundLocked" title="Lock/Unlock">
                    @(IsBackgroundLocked ? "ğŸ”’" : "ğŸ”“")
                </button>
                <div class="right-controls">
                     <button class="icon-btn" @onclick="UndoBackground" title="Undo">â†©ï¸</button>
                     <button class="ai-btn" @onclick="EnhanceBackground" disabled="@(IsBackgroundLocked || IsEnhancing)">
                        âœ¨ AI å®Œå–„
                     </button>
                </div>
            </div>
        </div>

        <!-- Protagonist Section -->
        <div class="section-box">
            <h3>ä¸»è§’è®¾å®š (Protagonist)</h3>
            <textarea @bind="Settings.Protagonist" @onfocusout="SaveWorldSettings" disabled="@IsProtagonistLocked" rows="10" placeholder="æè¿°ä¸»è§’çš„æ€§æ ¼ã€å¤–è²Œ..."></textarea>
            <div class="controls">
                <button class="icon-btn" @onclick="() => IsProtagonistLocked = !IsProtagonistLocked" title="Lock/Unlock">
                    @(IsProtagonistLocked ? "ğŸ”’" : "ğŸ”“")
                </button>
                 <div class="right-controls">
                     <button class="icon-btn" @onclick="UndoProtagonist" title="Undo">â†©ï¸</button>
                     <button class="ai-btn" @onclick="EnhanceProtagonist" disabled="@(IsProtagonistLocked || IsEnhancing)">
                        âœ¨ AI å®Œå–„
                     </button>
                </div>
            </div>
        </div>
    </div>
    
    @if (IsEnhancing)
    {
        <div class="loading-overlay">
            <div class="spinner"></div> AI æ­£åœ¨æ€è€ƒ...
        </div>
    }
</div>

@code {
    // UI çŠ¶æ€æ ‡å¿—
    private bool IsBackgroundLocked = false;
    private bool IsProtagonistLocked = false;
    private bool IsEnhancing = false;

    // ç®€å•çš„æ’¤é”€æ ˆ (ç›®å‰ä»…æ”¯æŒå•æ­¥æ’¤é”€)ï¼Œç”¨äºå›æ»š AI çš„ä¿®æ”¹
    private string LastBackground = "";
    private string LastProtagonist = "";

    protected override void OnInitialized()
    {
        LastBackground = Settings.Background;
        LastProtagonist = Settings.Protagonist;
    }

    /// <summary>
    /// è°ƒç”¨ LLM æœåŠ¡æ¥æ¶¦è‰²èƒŒæ™¯æè¿°ã€‚
    /// å¤„ç† UI çŠ¶æ€ï¼ˆåŠ è½½ä¸­ã€é”å®šï¼‰å¹¶è®°å½•é”™è¯¯æ—¥å¿—ã€‚
    /// </summary>
    private async Task EnhanceBackground()
    {
        if (!VerifyConfig()) return;
        
        Logger.Log("User requested background enhancement.");
        IsEnhancing = true;
        LastBackground = Settings.Background; // ä¿å­˜å½“å‰çŠ¶æ€ä»¥ä¾¿æ’¤é”€
        try
        {
            // è°ƒç”¨ LLM æœåŠ¡ï¼Œä½¿ç”¨ "Background" ä½œä¸ºä¸Šä¸‹æ–‡ç±»å‹
            Settings.Background = await Llm.EnhanceTextAsync(Settings.Background, "Background");
            await SaveWorldSettings();
        }
        catch (Exception ex) {_ = ex; /* LlmService ä¼šè®°å½•æ—¥å¿—ï¼ŒUI åªéœ€æ¢å¤çŠ¶æ€ */ }
        finally
        {
            IsEnhancing = false;
        }
    }

    /// <summary>
    /// è°ƒç”¨ LLM æœåŠ¡æ¥æ¶¦è‰²ä¸»è§’æè¿°ã€‚
    /// </summary>
    private async Task EnhanceProtagonist()
    {
        if (!VerifyConfig()) return;

        Logger.Log("User requested protagonist enhancement.");
        IsEnhancing = true;
        LastProtagonist = Settings.Protagonist; // ä¿å­˜çŠ¶æ€ä»¥ä¾¿æ’¤é”€
        try
        {
            Settings.Protagonist = await Llm.EnhanceTextAsync(Settings.Protagonist, "Protagonist");
            await SaveWorldSettings();
        }
        catch (Exception ex) { _ = ex; }
        finally
        {
            IsEnhancing = false;
        }
    }

    private async Task UndoBackground() 
    {
        Logger.Log("User undid background change.");
        Settings.Background = LastBackground;
        await SaveWorldSettings();
    }

    private async Task UndoProtagonist() 
    {
        Logger.Log("User undid protagonist change.");
        Settings.Protagonist = LastProtagonist;
        await SaveWorldSettings();
    }

    private async Task SaveWorldSettings()
    {
        await ConversationService.SaveCurrentStateAsync();
        Logger.Log("World settings saved automatically.");
    }

    /// <summary>
    /// åœ¨å°è¯• AI æ“ä½œå‰ï¼Œæ£€æŸ¥ API é…ç½®æ˜¯å¦æœ‰æ•ˆã€‚
    /// å¦‚æœé…ç½®ç¼ºå¤±ï¼Œå°†è·³è½¬åˆ°è®¾ç½®é¡µé¢ã€‚
    /// </summary>
    private bool VerifyConfig()
    {
        if (!Settings.IsModelConfigured)
        {
            Logger.Log("Config verification failed in WorldBuilding. Redirecting to settings.", LogLevel.Warning);
            Nav.NavigateTo("settings");
            return false;
        }
        return true;
    }
}

<style>
    .world-building {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Layout */
    .wb-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        flex: 1;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .alert-warning {
        background-color: #3e2723;
        color: #ffcc80;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-warning a { color: #ffcc80; text-decoration: underline; }

    .split-container {
        display: flex;
        gap: 20px;
        flex: 1;
        min-height: 0;
    }

    .section-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #252526;
        border-radius: 6px;
        padding: 15px;
    }

    h3 { margin-top: 0; color: #dcdcaa; font-size: 16px; }

    textarea {
        flex: 1;
        background-color: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #3e3e42;
        padding: 10px;
        border-radius: 4px;
        resize: none;
        font-family: inherit;
    }
    
    textarea:disabled { opacity: 0.6; cursor: not-allowed; }

    .controls {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }

    .right-controls { display: flex; gap: 10px; }

    .icon-btn, .ai-btn {
        background-color: #3e3e42;
        color: #d4d4d4;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .icon-btn:hover, .ai-btn:hover { background-color: #505055; }

    .ai-btn {
        background-color: #4CAF50;
        color: white;
    }
    .ai-btn:hover { background-color: #66bb6a; }
    .ai-btn:disabled { background-color: #2e3e30; color: gray; cursor: default; }

    .loading-overlay {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #0e639c;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 10px;
    }
</style>
