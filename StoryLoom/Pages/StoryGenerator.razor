@page "/"
@page "/story-generator"
@using StoryLoom.Services
@inject ConversationService ConversationService
@inject LlmService LlmService
@inject SettingsService SettingsService
@inject LogService Logger
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable

<div class="story-container">
    <!-- Header -->
    <div class="story-header">
        <div class="title-section">
            <span class="icon">üìñ</span>
            <input class="title-input" 
                   value="@ConversationService.CurrentConversation.Title"
                   @onchange="UpdateTitle"
                   placeholder="Story Title..." />
        </div>
        <div class="header-actions">
            <button class="btn-icon" title="New Conversation" @onclick="StartNewConversation" disabled="@IsGenerating">
                üÜï New Story
            </button>
            <button class="btn-icon" title="Settings" @onclick='() => Nav.NavigateTo("model-settings")'>
                 ‚öôÔ∏è
            </button>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chat-scroll-target">
        <!-- Optional Summary Banner -->
        @if (!string.IsNullOrEmpty(ConversationService.CurrentConversation.Summary))
        {
            <div class="summary-banner">
                <div class="summary-label">Previous Context Summary:</div>
                <div class="summary-text">@ConversationService.CurrentConversation.Summary</div>
            </div>
        }

        @foreach (var msg in ConversationService.CurrentConversation.Messages)
        {
            @if (msg.Role == "system") continue;

            <div class="message-row @(msg.Role == "user" ? "user-row" : "ai-row")">
                <div class="message-bubble">
                    <div class="message-role">@(msg.Role == "user" ? "You" : "AI")</div>
                    <div class="message-content">@msg.Content</div>
                </div>
            </div>
        }

        @if (IsGenerating)
        {
             <div class="message-row ai-row">
                <div class="message-bubble generating">
                    <div class="message-role">AI</div>
                    <div class="message-content">
                        @CurrentStreamText <span class="cursor">|</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="toolbar">
            <div class="action-menu-container" style="position: relative;">
                <button class="btn-tool" @onclick="ToggleActionMenu">
                    @(string.IsNullOrEmpty(SelectedAction) ? "üé≠ Actions" : SelectedAction)
                </button>
                @if (IsActionMenuOpen)
                {
                    <div class="dropdown-menu">
                        <button @onclick='() => SelectAction("üé≠ Actions")'>ü§ñ Auto</button>
                        <button @onclick='() => SelectAction("üé¨ Action")'>üé¨ Action</button>
                        <button @onclick='() => SelectAction("üó£Ô∏è Speak")'>üó£Ô∏è Speak</button>
                        <button @onclick='() => SelectAction("üí≠ Think")'>üí≠ Think</button>
                    </div>
                }
            </div>

            <div class="suggestion-menu-container" style="position: relative; z-index: 1001;">
                <button class="btn-tool" @onclick="ToggleSuggestionMenu">üí° Suggest</button>
                @if (IsSuggestionMenuOpen)
                {
                     <div class="dropdown-menu suggestions-menu">
                        <div class="menu-header">
                            <span class="menu-title">Suggestions (@(string.IsNullOrEmpty(SelectedAction) || SelectedAction == "üé≠ Actions" ? "Auto" : SelectedAction))</span>
                            <button class="btn-icon-small" title="Regenerate" @onclick="RegenerateSuggestions">üîÑ</button>
                        </div>
                        
                        @if (IsLoadingSuggestions)
                        {
                            <div class="menu-item-text">Loading suggestions...</div>
                        }
                        else if (Suggestions != null && Suggestions.Any())
                        {
                            @foreach (var suggestion in Suggestions)
                            {
                                 <button class="menu-item suggestion-item" @onclick="() => SelectSuggestion(suggestion)">
                                    @suggestion
                                </button>
                            }
                        }
                        else
                        {
                             <div class="menu-item-text">No suggestions available.</div>
                        }
                    </div>
                }
            </div>
            
            @if (IsActionMenuOpen || IsSuggestionMenuOpen)
            {
                <div class="menu-backdrop" @onclick="CloseMenus"></div>
            }
            
            <div class="spacer"></div>
            <span class="status-text">@(IsGenerating ? "Writing..." : "Ready")</span>
        </div>
        
        <div class="input-row">
            <textarea @bind="UserPrompt" 
                      @bind:event="oninput" 
                      @onkeydown="HandleKeyDown" 
                      placeholder="What happens next? (Ctrl+Enter to send)"
                      disabled="@IsGenerating"></textarea>
            <div class="input-actions-col">
                <button class="btn-tool btn-enhance" @onclick="EnhancePromptAsync" disabled="@(IsGenerating || string.IsNullOrWhiteSpace(UserPrompt) || IsEnhancing)">
                    @(IsEnhancing ? "‚ú®üîÑ" : "‚ú® Enhance")
                </button>
                <button class="btn-send" @onclick="SendMessage" disabled="@(IsGenerating || string.IsNullOrWhiteSpace(UserPrompt) || IsEnhancing)">
                    Send üöÄ
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private string UserPrompt { get; set; } = "";
    private string CurrentStreamText { get; set; } = "";
    private bool IsGenerating = false;
    private bool IsEnhancing = false;

    // Typewriter state
    private System.Text.StringBuilder _typewriterBuffer = new System.Text.StringBuilder();
    private bool _isTypewriterRunning = false;

    protected override void OnInitialized()
    {
        if (!SettingsService.IsStoryContextReady)
        {
             Logger.Log("Story context missing in Generator. Redirecting to WorldBuilding.");
             Nav.NavigateTo("world-building");
             return;
        }

        ConversationService.OnConversationUpdated += OnConversationUpdated;
        ScrollToBottom();
    }

    public void Dispose()
    {
        ConversationService.OnConversationUpdated -= OnConversationUpdated;
    }

    private void OnConversationUpdated()
    {
        InvokeAsync(() => {
            StateHasChanged();
            ScrollToBottom();
        });
    }

    private async Task UpdateTitle(ChangeEventArgs e)
    {
        var newTitle = e.Value?.ToString() ?? "Untitled";
        ConversationService.UpdateTitle(newTitle);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.CtrlKey && !IsGenerating)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserPrompt) || IsGenerating || IsEnhancing) return;

        var prompt = UserPrompt;
        UserPrompt = "";
        IsGenerating = true;
        CurrentStreamText = "";
        _typewriterBuffer.Clear();
        _isTypewriterRunning = true;
        
        // Start background consumption task for typewriter effect
        var typewriterTask = RunTypewriterAsync();

        try
        {
            // 1. Add User Message (Persists & potentially summarizes)
            await ConversationService.AddUserMessageAsync(prompt);

            // 2. Get Context (Recent History)
            var history = ConversationService.GetHistoryForLlm();
            var background = SettingsService.Background;
            var protagonist = SettingsService.Protagonist;
            var summary = ConversationService.CurrentConversation.Summary;

            // 3. Stream Response using new StartGenerateAsync
            // Pass the effective action (if any) to guide generation
            await foreach (var token in LlmService.StartGenerateAsync(history, background, protagonist, summary, GetEffectiveAction()))
            {
                // Push token to buffer instead of directly appending
                _typewriterBuffer.Append(token);
            }

            // Wait until the typewriter buffer is fully consumed
            while (_typewriterBuffer.Length > 0)
            {
                await Task.Delay(50);
            }

            // 4. Save Final AI Message
            await ConversationService.AddAiMessageAsync(CurrentStreamText);
            
            // CLEAR SUGGESTION CACHE here so next time we click Suggest it fetches new ones
            Suggestions.Clear();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SendMessage");
            CurrentStreamText += "\n[Error generating response]";
            await ConversationService.AddAiMessageAsync(CurrentStreamText); 
        }
        finally
        {
            _isTypewriterRunning = false;
            await typewriterTask; // Ensure it finishes safely
            
            IsGenerating = false;
            CurrentStreamText = "";
            StateHasChanged();
            ScrollToBottom();
        }
    }

    private async Task RunTypewriterAsync()
    {
        while (_isTypewriterRunning || _typewriterBuffer.Length > 0)
        {
            if (_typewriterBuffer.Length > 0)
            {
                // Take one character
                char ch = _typewriterBuffer[0];
                _typewriterBuffer.Remove(0, 1);
                
                CurrentStreamText += ch;
                StateHasChanged();
                ScrollToBottom();
                
                await Task.Delay(SettingsService.TextSpeed);
            }
            else
            {
                await Task.Delay(20); // Poll frequently when buffer empty but generating
            }
        }
    }

    private async Task EnhancePromptAsync()
    {
        if (string.IsNullOrWhiteSpace(UserPrompt) || IsGenerating || IsEnhancing) return;
        
        IsEnhancing = true;
        StateHasChanged();
        
        try
        {
            var enhanced = await LlmService.EnhanceTextAsync(UserPrompt, "auto");
            UserPrompt = enhanced;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "EnhancePromptAsync");
            ToastService toast = (ToastService)Nav.ToAbsoluteUri("").ToString().Length.ToString().Clone(); // fallback hack, use logger directly
        }
        finally
        {
            IsEnhancing = false;
            StateHasChanged();
        }
    }

    private async Task StartNewConversation()
    {
        if (IsGenerating) return;
        await ConversationService.StartNewConversationAsync();
        // Event will re-render
    }

    private bool IsActionMenuOpen = false;
    private string SelectedAction = "üé≠ Actions";
    
    private bool IsSuggestionMenuOpen = false;
    private bool IsLoadingSuggestions = false;
    private List<string> Suggestions = new List<string>();

    private void ToggleActionMenu()
    {
        IsActionMenuOpen = !IsActionMenuOpen;
        IsSuggestionMenuOpen = false; 
    }

    private void SelectAction(string action)
    {
        SelectedAction = action;
        IsActionMenuOpen = false;
    }

    private string? GetEffectiveAction()
    {
        // "üé≠ Actions" is the default/reset state (Auto)
        if (string.IsNullOrEmpty(SelectedAction) || SelectedAction == "üé≠ Actions" || SelectedAction == "ü§ñ Auto")
            return null;
        return SelectedAction;
    }

    private async Task ToggleSuggestionMenu()
    {
        IsSuggestionMenuOpen = !IsSuggestionMenuOpen;
        IsActionMenuOpen = false;
        
        if (IsSuggestionMenuOpen)
        {
            // If we have cached suggestions, just show them.
            // Unless the list is empty, then fetch.
            if (Suggestions == null || !Suggestions.Any())
            {
               await GetSuggestions();
            }
        }
    }

    private async Task GetSuggestions()
    {
        IsLoadingSuggestions = true;
        Suggestions.Clear();
        StateHasChanged();

        var context = ConversationService.GetHistoryForLlm();
        Suggestions = await LlmService.GetSuggestionsAsync(context, GetEffectiveAction());
        
        IsLoadingSuggestions = false;
        StateHasChanged();
    }
    
    private async Task RegenerateSuggestions()
    {
        // Force refresh
        await GetSuggestions();
    }

    private void CloseMenus()
    {
        IsActionMenuOpen = false;
        IsSuggestionMenuOpen = false;
    }

    private void SelectSuggestion(string text)
    {
        if (!string.IsNullOrEmpty(UserPrompt))
        {
             // Add a space if the prompt doesn't end with whitespace
             if (UserPrompt.Length > 0 && !char.IsWhiteSpace(UserPrompt.Last()))
             {
                 UserPrompt += " ";
             }
             UserPrompt += text;
        }
        else
        {
            UserPrompt = text;
        }
        IsSuggestionMenuOpen = false;
    }

    private async void ScrollToBottom()
    {
        // Simple JS interop to scroll
        try {
            await JS.InvokeVoidAsync("scrollToBottom", "chat-scroll-target");
        } catch { /* ignore if JS not ready */ }
    }
}

<script>
    window.scrollToBottom = (id) => {
        const el = document.getElementById(id);
        if (el) el.scrollTop = el.scrollHeight;
    }
</script>

<style>
    /* Layout */
    .story-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        height: 100%; /* Will fill the .content area provided by MainLayout */
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Header */
    .story-header {
        flex: 0 0 50px;
        background-color: #252526;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        align-items: center;
        padding: 0 15px;
        justify-content: space-between;
    }

    .title-section {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .title-input {
        background: transparent;
        border: 1px solid transparent;
        color: #fff;
        font-size: 1.1em;
        font-weight: bold;
        padding: 5px;
        width: 300px;
        transition: border 0.3s;
    }
    .title-input:focus {
        border: 1px solid #007acc;
        outline: none;
        background-color: #333;
    }

    .header-actions .btn-icon {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        font-size: 1.1em;
    }
    .header-actions .btn-icon:hover { background-color: #3e3e42; color: #fff; }

    /* Chat Area */
    .chat-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .summary-banner {
        background-color: #2d2d30;
        border-left: 4px solid #007acc;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 0.9em;
        opacity: 0.8;
    }
    .summary-label { font-weight: bold; color: #007acc; margin-bottom: 4px; }
    .summary-text { font-style: italic; color: #aaa; }

    .message-row { display: flex; width: 100%; }
    .user-row { justify-content: flex-end; }
    .ai-row { justify-content: flex-start; }

    .message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 8px;
        position: relative;
        line-height: 1.5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .user-row .message-bubble {
        background-color: #0e639c; /* VS Code Blue */
        color: #fff;
        border-bottom-right-radius: 2px;
    }

    .ai-row .message-bubble {
        background-color: #3c3c3c;
        color: #e0e0e0;
        border-bottom-left-radius: 2px;
        border: 1px solid #444;
    }

    .message-role {
        font-size: 0.75em;
        opacity: 0.7;
        margin-bottom: 4px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .message-content { white-space: pre-wrap; }

    /* Input Area */
    .input-area {
        flex: 0 0 auto;
        background-color: #252526;
        border-top: 1px solid #3e3e42;
        padding: 15px;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .btn-tool {
        background-color: #333;
        color: #ccc;
        border: 1px solid #444;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-tool:hover { background-color: #444; color: #fff; }

    .spacer { flex: 1; }
    .status-text { color: #888; font-size: 0.85em; }

    .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .input-actions-col {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    textarea {
        flex: 1;
        background-color: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        padding: 10px;
        resize: none;
        height: 70px; /* Base height */
        font-family: inherit;
    }
    textarea:focus { border-color: #007acc; outline: none; }

    .btn-enhance {
        background-color: #4a4a4a;
        color: #fff;
        border: none;
        padding: 5px 15px;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.85em;
    }
    .btn-enhance:hover { background-color: #5c5c5c; }
    .btn-enhance:disabled { background-color: #333; color: #888; cursor: not-allowed; }

    .btn-send {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 0 20px;
        height: 40px;
        flex: 1;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-send:hover { background-color: #0062a3; }
    .btn-send:disabled { background-color: #333; color: #888; cursor: not-allowed; }

    .cursor {
        display: inline-block;
        width: 8px;
        height: 1.2em;
        background-color: #ccc;
        vertical-align: bottom;
        animation: blink 1s infinite;
    }
    @@keyframes blink { 50% { opacity: 0; } }

    /* Dropdown Menus */
    .dropdown-menu {
        position: absolute;
        bottom: 100%; /* Show above button */
        left: 0;
        background-color: #252526;
        border: 1px solid #3e3e42;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        border-radius: 4px;
        padding: 5px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 1000;
        min-width: 150px;
        margin-bottom: 8px; /* Space between button and menu */
    }

    .dropdown-menu button {
        background: none;
        border: none;
        color: #ccc;
        text-align: left;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 3px;
        font-family: inherit;
        font-size: 0.95em;
        transition: background-color 0.2s;
    }
    .dropdown-menu button:hover {
        background-color: #007acc;
        color: white;
    }
    
    .suggestions-menu {
        width: 400px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .suggestion-item {
        border-bottom: 1px solid #333;
        line-height: 1.4;
    }
    .suggestion-item:last-child { border-bottom: none; }
    
    .menu-item-text {
        padding: 8px 12px;
        color: #888;
        font-style: italic;
    }

    /* New UI Elements for Suggestions */
    .menu-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 900; /* Below menus (z-index 1001) */
        cursor: default;
    }

    .menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px 10px;
        border-bottom: 1px solid #3e3e42;
        margin-bottom: 5px;
    }

    .menu-title {
        font-size: 0.8em;
        font-weight: bold;
        color: #888;
        text-transform: uppercase;
    }

    .btn-icon-small {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        line-height: 1;
        transition: background-color 0.2s;
    }
    .btn-icon-small:hover {
        background-color: #3e3e42;
        color: #fff;
    }
</style>
