@page "/"
@page "/story-generator"
@using StoryLoom.Services
@inject ConversationService ConversationService
@inject LlmService LlmService
@inject SettingsService SettingsService
@inject LogService Logger
@inject NavigationManager Nav
@inject IJSRuntime JS
@implements IDisposable

<div class="story-container">
    <!-- Header -->
    <div class="story-header">
        <div class="title-section">
            <span class="icon">üìñ</span>
            <input class="title-input" 
                   value="@ConversationService.CurrentConversation.Title"
                   @onchange="UpdateTitle"
                   placeholder="Story Title..." />
        </div>
        <div class="header-actions">
            <button class="btn-icon" title="New Conversation" @onclick="StartNewConversation" disabled="@IsGenerating">
                üÜï New Story
            </button>
            <button class="btn-icon" title="Settings" @onclick='() => Nav.NavigateTo("model-settings")'>
                 ‚öôÔ∏è
            </button>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chat-scroll-target">
        <!-- Optional Summary Banner -->
        @if (!string.IsNullOrEmpty(ConversationService.CurrentConversation.Summary))
        {
            <div class="summary-banner">
                <div class="summary-label">Previous Context Summary:</div>
                <div class="summary-text">@ConversationService.CurrentConversation.Summary</div>
            </div>
        }

        @foreach (var msg in ConversationService.CurrentConversation.Messages)
        {
            @if (msg.Role == "system") continue;

            <div class="message-row @(msg.Role == "user" ? "user-row" : "ai-row")">
                <div class="message-bubble">
                    <div class="message-role">@(msg.Role == "user" ? "You" : "AI")</div>
                    <div class="message-content">@msg.Content</div>
                </div>
            </div>
        }

        @if (IsGenerating)
        {
             <div class="message-row ai-row">
                <div class="message-bubble generating">
                    <div class="message-role">AI</div>
                    <div class="message-content">
                        @CurrentStreamText <span class="cursor">|</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="toolbar">
            <button class="btn-tool" @onclick="ShowActions">üé≠ Actions</button>
            <button class="btn-tool" @onclick="ShowSuggestions">üí° Suggest</button>
            <div class="spacer"></div>
            <span class="status-text">@(IsGenerating ? "Writing..." : "Ready")</span>
        </div>
        
        <div class="input-row">
            <textarea @bind="UserPrompt" 
                      @bind:event="oninput" 
                      @onkeydown="HandleKeyDown" 
                      placeholder="What happens next? (Ctrl+Enter to send)"
                      disabled="@IsGenerating"></textarea>
            <button class="btn-send" @onclick="SendMessage" disabled="@(IsGenerating || string.IsNullOrWhiteSpace(UserPrompt))">
                Send üöÄ
            </button>
        </div>
    </div>
</div>

@code {
    private string UserPrompt { get; set; } = "";
    private string CurrentStreamText { get; set; } = "";
    private bool IsGenerating = false;

    protected override void OnInitialized()
    {
        if (!SettingsService.IsStoryContextReady)
        {
             Logger.Log("Story context missing in Generator. Redirecting to WorldBuilding.");
             Nav.NavigateTo("world-building");
             return;
        }

        ConversationService.OnConversationUpdated += OnConversationUpdated;
        ScrollToBottom();
    }

    public void Dispose()
    {
        ConversationService.OnConversationUpdated -= OnConversationUpdated;
    }

    private void OnConversationUpdated()
    {
        InvokeAsync(() => {
            StateHasChanged();
            ScrollToBottom();
        });
    }

    private async Task UpdateTitle(ChangeEventArgs e)
    {
        var newTitle = e.Value?.ToString() ?? "Untitled";
        ConversationService.UpdateTitle(newTitle);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.CtrlKey && !IsGenerating)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(UserPrompt) || IsGenerating) return;

        var prompt = UserPrompt;
        UserPrompt = "";
        IsGenerating = true;
        CurrentStreamText = "";
        
        try
        {
            // 1. Add User Message (Persists & potentially summarizes)
            await ConversationService.AddUserMessageAsync(prompt);

            // 2. Get Context (Summary + Recent History + New User Msg)
            var context = ConversationService.GetContextForLlm();

            // 3. Stream Response
            await foreach (var token in LlmService.StreamCompletionAsync(context))
            {
                CurrentStreamText += token;
                StateHasChanged();
                ScrollToBottom();
            }

            // 4. Save Final AI Message
            await ConversationService.AddAiMessageAsync(CurrentStreamText);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "SendMessage");
            CurrentStreamText += "\n[Error generating response]";
            await ConversationService.AddAiMessageAsync(CurrentStreamText); // Log error in chat?
        }
        finally
        {
            IsGenerating = false;
            CurrentStreamText = "";
            StateHasChanged();
            ScrollToBottom();
        }
    }

    private async Task StartNewConversation()
    {
        if (IsGenerating) return;
        await ConversationService.StartNewConversationAsync();
        // Event will re-render
    }

    private void ShowActions()
    {
        // Placeholder
        Logger.Log("Action menu clicked");
    }

    private void ShowSuggestions()
    {
        // Placeholder
        Logger.Log("Suggestions clicked");
    }

    private async void ScrollToBottom()
    {
        // Simple JS interop to scroll
        try {
            await JS.InvokeVoidAsync("scrollToBottom", "chat-scroll-target");
        } catch { /* ignore if JS not ready */ }
    }
}

<script>
    window.scrollToBottom = (id) => {
        const el = document.getElementById(id);
        if (el) el.scrollTop = el.scrollHeight;
    }
</script>

<style>
    /* Layout */
    .story-container {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Full viewport height */
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Header */
    .story-header {
        flex: 0 0 50px;
        background-color: #252526;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        align-items: center;
        padding: 0 15px;
        justify-content: space-between;
    }

    .title-section {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
    }

    .title-input {
        background: transparent;
        border: 1px solid transparent;
        color: #fff;
        font-size: 1.1em;
        font-weight: bold;
        padding: 5px;
        width: 300px;
        transition: border 0.3s;
    }
    .title-input:focus {
        border: 1px solid #007acc;
        outline: none;
        background-color: #333;
    }

    .header-actions .btn-icon {
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        font-size: 1.1em;
    }
    .header-actions .btn-icon:hover { background-color: #3e3e42; color: #fff; }

    /* Chat Area */
    .chat-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .summary-banner {
        background-color: #2d2d30;
        border-left: 4px solid #007acc;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 0.9em;
        opacity: 0.8;
    }
    .summary-label { font-weight: bold; color: #007acc; margin-bottom: 4px; }
    .summary-text { font-style: italic; color: #aaa; }

    .message-row { display: flex; width: 100%; }
    .user-row { justify-content: flex-end; }
    .ai-row { justify-content: flex-start; }

    .message-bubble {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 8px;
        position: relative;
        line-height: 1.5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .user-row .message-bubble {
        background-color: #0e639c; /* VS Code Blue */
        color: #fff;
        border-bottom-right-radius: 2px;
    }

    .ai-row .message-bubble {
        background-color: #3c3c3c;
        color: #e0e0e0;
        border-bottom-left-radius: 2px;
        border: 1px solid #444;
    }

    .message-role {
        font-size: 0.75em;
        opacity: 0.7;
        margin-bottom: 4px;
        font-weight: bold;
        text-transform: uppercase;
    }

    .message-content { white-space: pre-wrap; }

    /* Input Area */
    .input-area {
        flex: 0 0 auto;
        background-color: #252526;
        border-top: 1px solid #3e3e42;
        padding: 15px;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .btn-tool {
        background-color: #333;
        color: #ccc;
        border: 1px solid #444;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-tool:hover { background-color: #444; color: #fff; }

    .spacer { flex: 1; }
    .status-text { color: #888; font-size: 0.85em; }

    .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    textarea {
        flex: 1;
        background-color: #1e1e1e;
        color: #d4d4d4;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        padding: 10px;
        resize: none;
        height: 60px; /* Base height */
        font-family: inherit;
    }
    textarea:focus { border-color: #007acc; outline: none; }

    .btn-send {
        background-color: #007acc;
        color: white;
        border: none;
        padding: 0 20px;
        height: 60px;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
    }
    .btn-send:hover { background-color: #0062a3; }
    .btn-send:disabled { background-color: #333; color: #888; cursor: not-allowed; }

    .cursor {
        display: inline-block;
        width: 8px;
        height: 1.2em;
        background-color: #ccc;
        vertical-align: bottom;
        animation: blink 1s infinite;
    }
    @@keyframes blink { 50% { opacity: 0; } }
</style>
